# RTFRAME逻辑端口自动方法

## 为什么需要逻辑端口号

两个DSP芯片或DSP核上的应用程序，使用通信中间件进行通信，必须要确定应用程序A、B两端的定位信息：

> A端所在节点RapidIO网络地址，A端逻辑端口号

> B端所在节点RapidIO网络地址，B端逻辑端口号

因此，一旦确定了以上的定位信息，通信中间件就可以在AB两端之间建立一条逻辑链路。

* 在蓝图工作模式下，应用程序A、B两端的逻辑端口是应用建模时提前规划好的，当蓝图部署完毕后，A、B程序就
部署到了确定的节点，RapidIO地址也就确定了，网管程序就可以根据定位信息配置逻辑通道。

* 在RTFRAME工作模式下，通过json编排形成的有向无环图，本质上与蓝图建模的功能蓝图类似。但json编排中不涉及逻辑端口号这些更低层更细节的东西，逻辑端口号是在运行的时候动态分配的。

## 怎样实现逻辑端口号的自动分配

为了实现逻辑端口号自动分配，RTFRAME中做了以下几点
* 1 我们把RapidIO逻辑端口号，纳入到节点的资源管理中来。我们假设一个节点管理器，管理了8个Dsp核，那么就存在8个Dsp核的数据结构，每个Dsp核的数据结构中，还存放了一个逻辑端口分配表。

* 2 任务驱动器在运行的过程中，首先根据计算图申请计算资源，然后，根据计算图的连接关系，向节点控制器申请逻辑端口号，节点控制器对逻辑端口分配表做了互斥保护，可以确保分配的端口号不发生冲突。

* 3 至此，任务驱动器就有了逻辑链路需要的两端地址，逻辑端口号这个关键要素，可以建立逻辑链路了。

在建立逻辑链路的实现上，有两种方法。

* 一种是任务驱动器与网管程序通信，通过网管程序建立逻辑链路。

* 另一种方式，是把建立逻辑链路的定位信息通过执行参数传递给DspWorker，由DspWorker调用通信中间件的建立逻辑通道函数，建立链接。

因为基于内存映射的中间件，支持节点间互相建立逻辑链路的功能，因此，在实现上，RTFRAME采用了第二种方式。